<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>每月人力工時管理 V1.2版</title>
    <!-- 載入 React 18 與 Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, Fragment } = React;

        /**
         * 自定義圖示組件 (Icon Component)
         */
        const Icon = ({ name, size = 16, className = "" }) => {
          const icons = {
            RefreshCw: <path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8m0 0V3m0 5h5M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16m0 0v5m0-5h-5" />,
            Settings: (
              <Fragment>
                <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V4a2 2 0 0 0-2-2z"/>
                <circle cx="12" cy="12" r="3"/>
              </Fragment>
            ),
            Table: (
              <Fragment>
                <path d="M19 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2ZM3 10h18M9 3v18" />
              </Fragment>
            ),
            Clock: (
              <Fragment>
                <circle cx="12" cy="12" r="10"/>
                <polyline points="12 6 12 12 16 14"/>
              </Fragment>
            ),
            AlertCircle: (
              <Fragment>
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" y1="8" x2="12" y2="12"/>
                <line x1="12" y1="16" x2="12.01" y2="16"/>
              </Fragment>
            ),
            ExternalLink: (
              <Fragment>
                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                <polyline points="15 3 21 3 21 9"/>
                <line x1="10" y1="14" x2="21" y2="3"/>
              </Fragment>
            ),
            Filter: <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3" />,
            PieChart: (
              <Fragment>
                <path d="M21.21 15.89A10 10 0 1 1 8 2.83" />
                <path d="M22 12A10 10 0 0 0 12 2v10z" />
              </Fragment>
            ),
            CheckSquare: (
              <Fragment>
                <polyline points="9 11 12 14 22 4"/>
                <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11" />
              </Fragment>
            ),
            Square: <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />,
            Database: (
              <Fragment>
                <ellipse cx="12" cy="5" rx="9" ry="3"/>
                <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/>
                <path d="M3 12c0 1.66 4 3 9 3s9-1.34 9-3"/>
              </Fragment>
            ),
            ClipboardList: (
              <Fragment>
                <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/>
                <rect x="8" y="2" width="8" height="4" rx="1" ry="1"/>
                <line x1="8" y1="11" x2="8" y2="11"/><line x1="8" y1="16" x2="8" y2="16"/>
                <line x1="12" y1="11" x2="16" y2="11"/><line x1="12" y1="16" x2="16" y2="16"/>
              </Fragment>
            ),
            Trash2: (
              <Fragment>
                <polyline points="3 6 5 6 21 6"/>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                <line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/>
              </Fragment>
            ),
            Calculator: (
              <Fragment>
                <rect x="4" y="2" width="16" height="20" rx="2"/>
                <line x1="8" y1="6" x2="16" y2="6"/>
                <line x1="16" y1="14" x2="16" y2="14"/><line x1="16" y1="18" x2="16" y2="18"/>
                <line x1="12" y1="14" x2="12" y2="14"/><line x1="12" y1="18" x2="12" y2="18"/>
                <line x1="8" y1="14" x2="8" y2="14"/><line x1="8" y1="18" x2="8" y2="18"/>
              </Fragment>
            ),
            Download: (
              <Fragment>
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7 10 12 15 17 10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
              </Fragment>
            ),
            Check: <polyline points="20 6 9 17 4 12" />,
            Info: (
              <Fragment>
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" y1="16" x2="12" y2="12"/>
                <line x1="12" y1="8" x2="12.01" y2="8"/>
              </Fragment>
            ),
            Inbox: (
              <Fragment>
                <polyline points="22 12 16 12 14 15 10 15 8 12 2 12"/>
                <path d="M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z" />
              </Fragment>
            ),
            AlertTriangle: (
              <Fragment>
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                <line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
              </Fragment>
            ),
            FileDown: (
              <Fragment>
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
                <path d="M12 18v-6"/>
                <polyline points="9 15 12 18 15 15"/>
              </Fragment>
            ),
            Share2: (
              <Fragment>
                <circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/>
                <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
              </Fragment>
            ),
            Activity: <path d="M22 12h-4l-3 9L9 3l-3 9H2" />,
            Calendar: <Fragment><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></Fragment>
          };

          return (
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width={size}
              height={size}
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              strokeWidth="2"
              strokeLinecap="round"
              strokeLinejoin="round"
              className={className}
            >
              {icons[name] || null}
            </svg>
          );
        };

        const DEFAULT_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSvwX89axOk5qdnomA9fDPQpMMwUDFP8cYZjw3hm05zZ8-Y9i8xkD4ozrpV_EPtLrrwmYo_sNB_voEs/pub?output=csv";

        const App = () => {
          const [activeTab, setActiveTab] = useState('dashboard');
          const [csvUrl, setCsvUrl] = useState(DEFAULT_CSV_URL);
          const [rawData, setRawData] = useState([]);
          const [headers, setHeaders] = useState([]);
          const [isLoading, setIsLoading] = useState(false);
          const [lastUpdated, setLastUpdated] = useState(null);
          const [statusMap, setStatusMap] = useState({});
          
          const [filters, setFilters] = useState({ project: 'all', month: 'all' });
          const [selectedIndices, setSelectedIndices] = useState(new Set());

          const [pastedText, setPastedText] = useState("");
          const [pastedResults, setPastedResults] = useState([]); 
          const [parsedRowsToImport, setParsedRowsToImport] = useState([]); 
          const [importSuccess, setImportSuccess] = useState(false);
          const [parseError, setParseError] = useState("");
          const [showClearConfirm, setShowClearConfirm] = useState(false);

          // 共用成本分頁狀態
          const [sharedForm, setSharedForm] = useState({
            groupName: "【客服組】",
            totalHours: "59.85",
            projectsText: "【客服組】明星3缺1\n【客服組】滿貫大亨\n【客服組】金好運TW\n【客服組】金猴爺",
            month: new Date().toISOString().slice(0, 7) // 預設當月
          });
          const [sharedResults, setSharedResults] = useState([]);

          const cleanNumber = (val) => {
            if (!val) return 0;
            const cleaned = String(val).replace(/[^0-9.-]/g, '');
            const num = parseFloat(cleaned);
            return isNaN(num) ? 0 : num;
          };

          const normalizeMonth = (val) => {
            if (!val) return '未知月份';
            const str = String(val).trim();
            const dateMatch = str.match(/^(\d{4})[-/](\d{1,2})/);
            if (dateMatch) {
              const year = dateMatch[1];
              const month = dateMatch[2].padStart(2, '0');
              return `${year}-${month}`;
            }
            const pureNumMatch = str.match(/^(\d{4})(\d{2})$/);
            if (pureNumMatch) return `${pureNumMatch[1]}-${pureNumMatch[2]}`;
            if (/^\d{4}-\d{2}$/.test(str)) return str;
            return str;
          };

          const parseCSV = (text) => {
            const lines = text.split(/\r?\n/);
            if (lines.length === 0) return { headers: [], rows: [] };
            const rows = lines
              .filter(line => line.trim() !== '')
              .map(line => {
                const matches = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || line.split(',');
                return matches.map(cell => cell.replace(/^"|"$/g, '').trim());
              });
            return { headers: rows[0] || [], content: rows.slice(1) };
          };

          const fetchSheetData = async () => {
            setIsLoading(true);
            try {
              const response = await fetch(csvUrl);
              if (!response.ok) throw new Error('無法讀取資料');
              const text = await response.text();
              const { headers, content } = parseCSV(text);
              setHeaders(headers);
              setRawData(content);
              setLastUpdated(new Date().toLocaleString('zh-TW'));
              
              const newStatusMap = {};
              content.forEach((_, index) => { newStatusMap[index] = '已上傳'; });
              setStatusMap(newStatusMap);
              setSelectedIndices(new Set());
            } catch (error) {
              console.error(error);
            } finally {
              setIsLoading(false);
            }
          };

          useEffect(() => { fetchSheetData(); }, []);

          const handleClearAllData = () => {
            setRawData([]); setStatusMap({}); setSelectedIndices(new Set()); setLastUpdated(null);
            setPastedResults([]); setParsedRowsToImport([]); setPastedText(""); setShowClearConfirm(false);
          };

          const colIndices = useMemo(() => {
            const find = (keywords) => headers.findIndex(h => keywords.some(k => h.includes(k)));
            return {
              user: find(['用戶', '人員', '姓名', 'User', 'Name']),
              project: find(['專案', 'Project', '名稱']),
              month: find(['月份', 'Month']),
              date: find(['日期', 'Date']),
              hours: find(['小時', '工時', 'Hours', '時數'])
            };
          }, [headers]);

          const handleExportCSV = (dataToExport, fileNamePrefix = '工時報表') => {
            if (!dataToExport || dataToExport.length === 0) return;
            let csvString = "";
            if (Array.isArray(dataToExport[0]?.row)) {
              csvString += headers.join(",") + ",狀態\n";
              dataToExport.forEach(({ row, originalIdx }) => {
                const status = statusMap[originalIdx] || '未知';
                const escapedRow = row.map(cell => `"${(cell || "").replace(/"/g, '""')}"`);
                csvString += escapedRow.join(",") + `,${status}\n`;
              });
            } else {
              csvString += "專案名稱,月份,原成本工時,共用分攤工時,總計總工時,資料筆數\n";
              dataToExport.forEach(item => {
                csvString += `"${item.name}","${item.month}",${item.originalHours.toFixed(3)},${item.sharedHours.toFixed(3)},${item.totalHours.toFixed(3)},${item.count}\n`;
              });
            }
            const blob = new Blob(["\uFEFF" + csvString], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", `${fileNamePrefix}_${new Date().toISOString().slice(0, 10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
          };

          const handleProcessPastedText = () => {
            setParseError("");
            if (!pastedText.trim()) { setParseError("請先貼入內容再進行計算"); return; }
            const lines = pastedText.trim().split('\n');
            const tempStats = {};
            const rowsForImport = [];
            let validCount = 0;
            lines.forEach((line) => {
              const parts = line.split(/[\t,]| {1,}/).map(p => p.trim()).filter(p => p !== "");
              if (parts.length >= 3) {
                const project = parts[0];
                const month = normalizeMonth(parts[1]); 
                const hours = cleanNumber(parts[2]);
                if (isNaN(hours)) return;
                const key = `${project}_${month}`;
                if (!tempStats[key]) tempStats[key] = { project, month, totalHours: 0, count: 0 };
                tempStats[key].totalHours = (Math.round((tempStats[key].totalHours + hours) * 1000) / 1000);
                tempStats[key].count += 1;
                const row = new Array(headers.length).fill('');
                if (colIndices.project !== -1) row[colIndices.project] = project;
                if (colIndices.month !== -1) row[colIndices.month] = month;
                else if (colIndices.date !== -1) row[colIndices.date] = month;
                if (colIndices.hours !== -1) row[colIndices.hours] = hours.toString();
                if (colIndices.user !== -1) row[colIndices.user] = "貼上匯入";
                if (colIndices.date !== -1 && !row[colIndices.date]) row[colIndices.date] = new Date().toLocaleDateString();
                rowsForImport.push(row);
                validCount++;
              }
            });
            if (validCount === 0) {
              setParseError("格式錯誤：請確保為「專案 月份 工時」");
              setPastedResults([]); setParsedRowsToImport([]);
            } else {
              setPastedResults(Object.values(tempStats).sort((a, b) => b.totalHours - a.totalHours));
              setParsedRowsToImport(rowsForImport);
              setImportSuccess(false);
            }
          };

          const handleImportToSystem = (sourceData = parsedRowsToImport) => {
            if (sourceData.length === 0) return;
            const updatedRawData = [...rawData, ...sourceData];
            setRawData(updatedRawData);
            const updatedStatusMap = { ...statusMap };
            const startIndex = rawData.length;
            sourceData.forEach((_, i) => { updatedStatusMap[startIndex + i] = '已上傳'; });
            setStatusMap(updatedStatusMap);
            setImportSuccess(true);
            setTimeout(() => { setActiveTab('pending'); }, 1000);
          };

          // 計算共用成本
          const handleCalcSharedCost = () => {
            const projects = sharedForm.projectsText.split('\n').map(p => p.trim()).filter(p => p !== "");
            const totalH = cleanNumber(sharedForm.totalHours);
            if (projects.length === 0 || totalH === 0) return;

            const avgH = totalH / projects.length;
            const results = projects.map(p => ({
              project: p,
              month: sharedForm.month,
              hours: avgH.toFixed(3)
            }));
            
            setSharedResults(results);
          };

          const handleImportSharedCost = () => {
            if (sharedResults.length === 0) return;
            const rows = sharedResults.map(res => {
              const row = new Array(headers.length).fill('');
              if (colIndices.project !== -1) row[colIndices.project] = res.project;
              if (colIndices.month !== -1) row[colIndices.month] = res.month;
              else if (colIndices.date !== -1) row[colIndices.date] = res.month;
              if (colIndices.hours !== -1) row[colIndices.hours] = res.hours;
              if (colIndices.user !== -1) row[colIndices.user] = `共用分攤(${sharedForm.groupName})`;
              if (colIndices.date !== -1 && !row[colIndices.date]) row[colIndices.date] = new Date().toLocaleDateString();
              return row;
            });
            handleImportToSystem(rows);
          };

          const sourceVisibleCols = useMemo(() => {
            const list = [colIndices.user, colIndices.project, colIndices.month !== -1 ? colIndices.month : colIndices.date, colIndices.date, colIndices.hours];
            return list.filter((idx, i, self) => idx !== -1 && self.indexOf(idx) === i);
          }, [colIndices]);

          const filterOptions = useMemo(() => {
            const projects = new Set();
            const months = new Set();
            rawData.forEach(row => {
              if (colIndices.project !== -1 && row[colIndices.project]) projects.add(row[colIndices.project].trim());
              let rawMonthVal = (colIndices.month !== -1 && row[colIndices.month]) ? row[colIndices.month] : (colIndices.date !== -1 ? row[colIndices.date] : '');
              if (rawMonthVal) months.add(normalizeMonth(rawMonthVal));
            });
            return { projects: Array.from(projects).sort(), months: Array.from(months).sort() };
          }, [rawData, colIndices]);

          const filteredData = useMemo(() => {
            return rawData.map((row, idx) => ({ row, originalIdx: idx })).filter(({ row }) => {
              const pName = colIndices.project !== -1 ? (row[colIndices.project] || '').trim() : '';
              const pMonth = normalizeMonth((colIndices.month !== -1 && row[colIndices.month]) ? row[colIndices.month] : (colIndices.date !== -1 ? row[colIndices.date] : ''));
              return (filters.project === 'all' || pName === filters.project) && (filters.month === 'all' || pMonth === filters.month);
            });
          }, [rawData, filters, colIndices]);

          const pendingData = useMemo(() => filteredData.filter(({ originalIdx }) => statusMap[originalIdx] === '已上傳'), [filteredData, statusMap]);

          const projectStats = useMemo(() => {
            if (colIndices.project === -1) return [];
            const stats = {};
            filteredData.forEach(({ row }) => {
              const pName = (row[colIndices.project] || '未分類').trim();
              
              // 自動排除包含「共用成本」的項目以防止重複計算
              if (pName.includes('共用成本')) return;

              const pMonth = normalizeMonth((colIndices.month !== -1 && row[colIndices.month]) ? row[colIndices.month] : (colIndices.date !== -1 ? row[colIndices.date] : '')) || '未知月份';
              const hours = cleanNumber(colIndices.hours !== -1 ? row[colIndices.hours] : '0');
              const userVal = colIndices.user !== -1 ? (row[colIndices.user] || '') : '';
              
              const key = `${pName}_${pMonth}`;
              if (!stats[key]) {
                stats[key] = { name: pName, month: pMonth, originalHours: 0, sharedHours: 0, totalHours: 0, count: 0 };
              }
              
              if (userVal.includes('共用分攤')) {
                stats[key].sharedHours = (Math.round((stats[key].sharedHours + hours) * 1000) / 1000);
              } else {
                stats[key].originalHours = (Math.round((stats[key].originalHours + hours) * 1000) / 1000);
              }
              
              stats[key].totalHours = (Math.round((stats[key].originalHours + stats[key].sharedHours) * 1000) / 1000);
              stats[key].count += 1;
            });
            return Object.values(stats).sort((a, b) => a.month !== b.month ? b.month.localeCompare(a.month) : a.name.localeCompare(b.name));
          }, [filteredData, colIndices]);

          // 計算目前篩選範圍內的總計
          const grandTotals = useMemo(() => {
            const res = projectStats.reduce((acc, curr) => {
              acc.original += curr.originalHours;
              acc.shared += curr.sharedHours;
              acc.total += curr.totalHours;
              acc.count += curr.count;
              return acc;
            }, { original: 0, shared: 0, total: 0, count: 0 });

            // 確保精度
            return {
              original: Math.round(res.original * 1000) / 1000,
              shared: Math.round(res.shared * 1000) / 1000,
              total: Math.round(res.total * 1000) / 1000,
              count: res.count
            };
          }, [projectStats]);

          const batchUpdateStatus = (newStatus) => {
            const nextMap = { ...statusMap };
            selectedIndices.forEach(idx => { nextMap[idx] = newStatus; });
            setStatusMap(nextMap);
            setSelectedIndices(new Set());
          };

          const toggleSelectAll = (targetData) => {
            if (selectedIndices.size === targetData.length) setSelectedIndices(new Set());
            else setSelectedIndices(new Set(targetData.map(d => d.originalIdx)));
          };

          const toggleSelectRow = (idx) => {
            const next = new Set(selectedIndices);
            if (next.has(idx)) next.delete(idx); else next.add(idx);
            setSelectedIndices(next);
          };

          const getStatusStyle = (s) => {
            if (s === '已上傳') return 'bg-blue-100 text-blue-700 border-blue-200';
            if (s === '計算中') return 'bg-amber-100 text-amber-700 border-amber-200';
            if (s === '已結案') return 'bg-emerald-100 text-emerald-700 border-emerald-200';
            return 'bg-slate-100';
          };

          return (
            <div className="min-h-screen pb-20 relative font-medium">
              {showClearConfirm && (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm animate-in fade-in duration-200">
                  <div className="bg-white rounded-3xl shadow-2xl max-w-sm w-full overflow-hidden">
                    <div className="p-8 text-center space-y-4">
                      <div className="mx-auto w-16 h-16 bg-red-50 rounded-full flex items-center justify-center">
                        <Icon name="AlertTriangle" size={32} className="text-red-500" />
                      </div>
                      <h3 className="text-xl font-bold">確認清空資料？</h3>
                      <p className="text-sm text-slate-500">這將會移除目前所有的暫存數據與匯入紀錄，此操作無法復原。</p>
                    </div>
                    <div className="grid grid-cols-2 border-t font-bold">
                      <button onClick={() => setShowClearConfirm(false)} className="py-4 text-slate-400 border-r hover:bg-slate-50 transition-colors">取消</button>
                      <button onClick={handleClearAllData} className="py-4 text-red-500 hover:bg-red-50 transition-colors">確認清空</button>
                    </div>
                  </div>
                </div>
              )}

              <header className="bg-white border-b sticky top-0 z-30 shadow-sm">
                <div className="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
                  <div className="flex items-center space-x-3">
                    <div className="bg-slate-900 p-2 rounded-lg shadow-lg">
                      <Icon name="Table" size={20} className="text-white" />
                    </div>
                    <h1 className="text-lg font-bold hidden sm:block tracking-tight">每月人力工時管理 V1.2版</h1>
                  </div>
                  <nav className="flex space-x-1 bg-slate-100 p-1 rounded-xl overflow-x-auto no-scrollbar">
                    {[
                      { id: 'dashboard', label: '統計', icon: 'PieChart' }, 
                      { id: 'shared', label: '共用成本', icon: 'Share2' },
                      { id: 'pending', label: '待處理', icon: 'Inbox' }, 
                      { id: 'pasteCalc', label: '匯入', icon: 'ClipboardList' }, 
                      { id: 'source', label: '明細', icon: 'Database' }, 
                      { id: 'settings', label: '設定', icon: 'Settings' }
                    ].map(t => (
                      <button key={t.id} onClick={() => {setActiveTab(t.id); setSelectedIndices(new Set());}} className={`flex items-center space-x-2 px-4 py-1.5 rounded-lg text-sm font-bold transition-all whitespace-nowrap ${activeTab === t.id ? 'bg-white text-slate-900 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>
                        <Icon name={t.icon} size={16} />
                        <span>{t.label}</span>
                        {t.id === 'pending' && pendingData.length > 0 && (<span className="bg-red-500 text-white text-[10px] px-1.5 py-0.5 rounded-full font-bold ml-1 animate-pulse">{pendingData.length}</span>)}
                      </button>
                    ))}
                  </nav>
                </div>
              </header>

              <main className="max-w-7xl mx-auto px-4 py-8 space-y-8">
                {(activeTab !== 'settings' && activeTab !== 'pasteCalc' && activeTab !== 'shared') && (
                  <div className="bg-white p-6 rounded-2xl border flex flex-wrap items-end gap-4 shadow-xl max-w-4xl mx-auto">
                    <div className="flex-1 min-w-[180px] space-y-2">
                      <label className="text-xs font-bold text-slate-400 uppercase tracking-widest flex items-center"><Icon name="Filter" size={12} className="mr-1" /> 專案篩選</label>
                      <select value={filters.project} onChange={(e) => setFilters(prev => ({...prev, project: e.target.value}))} className="w-full bg-slate-50 border rounded-xl px-4 py-2.5 text-sm outline-none focus:ring-2 font-bold">
                        <option value="all">所有專案</option>
                        {filterOptions.projects.map(p => <option key={p} value={p}>{p}</option>)}
                      </select>
                    </div>
                    <div className="flex-1 min-w-[180px] space-y-2">
                      <label className="text-xs font-bold text-slate-400 uppercase tracking-widest flex items-center"><Icon name="Filter" size={12} className="mr-1" /> 月份篩選</label>
                      <select value={filters.month} onChange={(e) => setFilters(prev => ({...prev, month: e.target.value}))} className="w-full bg-slate-50 border rounded-xl px-4 py-2.5 text-sm outline-none focus:ring-2 font-bold">
                        <option value="all">所有月份</option>
                        {filterOptions.months.map(m => <option key={m} value={m}>{m}</option>)}
                      </select>
                    </div>
                    <button onClick={fetchSheetData} disabled={isLoading} className="bg-slate-800 hover:bg-black text-white h-[44px] px-6 rounded-xl font-bold transition-all flex items-center space-x-2 shadow-lg text-sm uppercase tracking-wider"><Icon name="RefreshCw" size={14} className={isLoading ? 'animate-spin' : ''} /> <span>同步雲端</span></button>
                  </div>
                )}

                {activeTab === 'dashboard' ? (
                  <section className="space-y-6 animate-in fade-in duration-300 max-w-5xl mx-auto">
                    <div className="flex items-center justify-between">
                      <div className="flex items-center space-x-2 text-slate-800">
                        <Icon name="PieChart" size={20} />
                        <h2 className="text-xl font-bold">專案工時統計分析表</h2>
                        {filters.month !== 'all' && <span className="ml-2 px-3 py-1 bg-slate-900 text-white text-[10px] rounded-full uppercase tracking-tighter font-black">{filters.month} 數據</span>}
                      </div>
                      <button onClick={() => handleExportCSV(projectStats, '工時統計報表')} disabled={projectStats.length === 0} className="flex items-center space-x-1.5 px-5 py-2.5 bg-emerald-600 text-white rounded-xl shadow-lg hover:bg-emerald-700 transition-all text-xs font-bold uppercase tracking-widest"><Icon name="FileDown" size={14} /><span>匯出報表</span></button>
                    </div>

                    {/* 總統計概覽卡片：動態標題對應篩選 */}
                    <div className="space-y-3">
                        <div className="flex items-center space-x-2 text-xs font-black text-slate-400 uppercase tracking-widest pl-2">
                            <Icon name="Calendar" size={14} />
                            <span>{filters.month === 'all' ? '全時段累計總覽' : `${filters.month} 月份統計概覽`}</span>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div className="bg-white p-6 rounded-3xl border shadow-md flex items-center space-x-4 border-l-4 border-l-blue-500">
                                <div className="bg-blue-50 p-3 rounded-2xl"><Icon name="Activity" size={24} className="text-blue-600" /></div>
                                <div>
                                <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">總原成本工時</p>
                                <p className="text-2xl font-black text-blue-600 leading-tight">
                                    {grandTotals.original.toLocaleString(undefined, { minimumFractionDigits: 3 })}
                                    <span className="text-xs ml-1 opacity-50 font-normal italic">H</span>
                                </p>
                                </div>
                            </div>
                            <div className="bg-white p-6 rounded-3xl border shadow-md flex items-center space-x-4 border-l-4 border-l-indigo-500">
                                <div className="bg-indigo-50 p-3 rounded-2xl"><Icon name="Share2" size={24} className="text-indigo-600" /></div>
                                <div>
                                <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">總分攤工時</p>
                                <p className="text-2xl font-black text-indigo-600 leading-tight">
                                    {grandTotals.shared.toLocaleString(undefined, { minimumFractionDigits: 3 })}
                                    <span className="text-xs ml-1 opacity-50 font-normal italic">H</span>
                                </p>
                                </div>
                            </div>
                            <div className="bg-slate-900 p-6 rounded-3xl shadow-xl flex items-center space-x-4">
                                <div className="bg-white/10 p-3 rounded-2xl"><Icon name="Clock" size={24} className="text-white" /></div>
                                <div>
                                <p className="text-[10px] font-black text-white/50 uppercase tracking-widest">最終累計總工時</p>
                                <p className="text-2xl font-black text-white leading-tight">
                                    {grandTotals.total.toLocaleString(undefined, { minimumFractionDigits: 3 })}
                                    <span className="text-xs ml-1 opacity-50 font-normal">H</span>
                                </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="bg-white rounded-3xl border shadow-2xl overflow-hidden">
                      <div className="overflow-x-auto">
                        <table className="w-full text-left border-separate border-spacing-0">
                          <thead className="bg-slate-50/80">
                            <tr>
                              <th className="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-widest border-b">專案名稱</th>
                              <th className="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-widest border-b text-center">月份</th>
                              <th className="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-widest text-right border-b bg-blue-50/30">原成本工時</th>
                              <th className="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-widest text-right border-b bg-indigo-50/30">共用分攤工時</th>
                              <th className="px-6 py-4 text-xs font-bold text-slate-900 uppercase tracking-widest text-right border-b bg-slate-100/50">總計總工時</th>
                              <th className="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-widest text-right border-b">筆數</th>
                            </tr>
                          </thead>
                          <tbody className="divide-y font-bold">
                            {projectStats.length > 0 ? (
                              <Fragment>
                                {projectStats.map((stat, i) => (
                                  <tr key={i} className="hover:bg-slate-50/80 transition-colors group">
                                    <td className="px-6 py-5"><span className="text-slate-800">{stat.name}</span></td>
                                    <td className="px-6 py-5 text-slate-500 text-sm text-center font-mono">{stat.month}</td>
                                    <td className="px-6 py-5 text-right text-blue-600 font-bold bg-blue-50/10">
                                      {stat.originalHours.toLocaleString(undefined, { minimumFractionDigits: 3 })}
                                      <span className="text-[10px] text-blue-300 ml-1">H</span>
                                    </td>
                                    <td className="px-6 py-5 text-right text-indigo-600 font-bold bg-indigo-50/10">
                                      {stat.sharedHours.toLocaleString(undefined, { minimumFractionDigits: 3 })}
                                      <span className="text-[10px] text-indigo-300 ml-1">H</span>
                                    </td>
                                    <td className="px-6 py-5 text-right text-slate-900 text-lg font-black bg-slate-50/50">
                                      {stat.totalHours.toLocaleString(undefined, { minimumFractionDigits: 3 })}
                                      <span className="text-[10px] text-slate-400 ml-1">H</span>
                                    </td>
                                    <td className="px-6 py-5 text-right text-slate-400 text-xs">{stat.count}</td>
                                  </tr>
                                ))}
                                <tr className="bg-slate-800 text-white font-black shadow-[0_-4px_10px_rgba(0,0,0,0.1)]">
                                  <td colSpan="2" className="px-6 py-5 text-right">
                                    <div className="flex flex-col items-end">
                                        <span className="text-[10px] opacity-60 uppercase tracking-widest">Selected Summary</span>
                                        <span className="text-xs">{filters.month === 'all' ? '所有資料全選總計' : `${filters.month} 月份範圍總計`}</span>
                                    </div>
                                  </td>
                                  <td className="px-6 py-5 text-right text-blue-400 border-l border-white/10">
                                    {grandTotals.original.toLocaleString(undefined, { minimumFractionDigits: 3 })}H
                                  </td>
                                  <td className="px-6 py-5 text-right text-indigo-400 border-l border-white/10">
                                    {grandTotals.shared.toLocaleString(undefined, { minimumFractionDigits: 3 })}H
                                  </td>
                                  <td className="px-6 py-5 text-right text-emerald-400 text-xl border-l border-white/20 bg-black/20">
                                    {grandTotals.total.toLocaleString(undefined, { minimumFractionDigits: 3 })}H
                                  </td>
                                  <td className="px-6 py-5 text-right text-white/40 text-xs border-l border-white/10">{grandTotals.count} 筆</td>
                                </tr>
                              </Fragment>
                            ) : <tr><td colSpan="6" className="py-24 text-center text-slate-300 font-bold italic">目前尚無數據報表</td></tr>}
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </section>
                ) : activeTab === 'shared' ? (
                  <section className="space-y-6 animate-in fade-in duration-300 max-w-4xl mx-auto">
                    <div className="flex items-center space-x-2 text-slate-800"><Icon name="Share2" size={20} /><h2 className="text-xl font-bold">共用成本均分計算器</h2></div>
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                      <div className="bg-white rounded-3xl border p-8 space-y-6 shadow-xl">
                        <div className="grid grid-cols-2 gap-4">
                          <div className="space-y-2">
                            <label className="text-xs font-bold text-slate-400 uppercase tracking-widest">分攤組別名稱</label>
                            <input 
                              type="text" 
                              value={sharedForm.groupName} 
                              onChange={(e) => setSharedForm({...sharedForm, groupName: e.target.value})}
                              placeholder="例：【客服組】"
                              className="w-full bg-slate-50 border rounded-xl px-4 py-2.5 text-sm font-bold outline-none" 
                            />
                          </div>
                          <div className="space-y-2">
                            <label className="text-xs font-bold text-slate-400 uppercase tracking-widest">歸屬月份</label>
                            <input 
                              type="month" 
                              value={sharedForm.month} 
                              onChange={(e) => setSharedForm({...sharedForm, month: e.target.value})}
                              className="w-full bg-slate-50 border rounded-xl px-4 py-2 text-sm font-bold outline-none" 
                            />
                          </div>
                        </div>
                        <div className="space-y-2">
                          <label className="text-xs font-bold text-slate-400 uppercase tracking-widest">共用總時數 (H)</label>
                          <input 
                            type="number" 
                            value={sharedForm.totalHours} 
                            onChange={(e) => setSharedForm({...sharedForm, totalHours: e.target.value})}
                            className="w-full bg-slate-50 border rounded-xl px-4 py-2.5 text-lg font-bold outline-none text-indigo-600" 
                          />
                        </div>
                        <div className="space-y-2">
                          <label className="text-xs font-bold text-slate-400 uppercase tracking-widest">目標專案清單 (一行一個專案)</label>
                          <textarea 
                            value={sharedForm.projectsText} 
                            onChange={(e) => setSharedForm({...sharedForm, projectsText: e.target.value})}
                            className="w-full h-40 bg-slate-50 border rounded-xl p-4 text-sm font-bold outline-none resize-none" 
                            placeholder="貼入專案名稱..."
                          />
                        </div>
                        <button onClick={handleCalcSharedCost} className="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold shadow-xl hover:bg-indigo-700 transition-all">計算分攤結果</button>
                      </div>

                      <div className="bg-white rounded-3xl border shadow-xl flex flex-col overflow-hidden">
                        <div className="px-6 py-4 border-b bg-slate-50 flex justify-between items-center">
                          <h3 className="text-sm font-bold">分攤預覽</h3>
                          {sharedResults.length > 0 && (
                            <button onClick={handleImportSharedCost} className="bg-slate-900 text-white text-[10px] px-4 py-2 rounded-lg font-bold shadow-lg">匯入待處理區</button>
                          )}
                        </div>
                        <div className="flex-1 overflow-y-auto max-h-[500px]">
                          {sharedResults.length > 0 ? (
                            <table className="w-full text-left">
                              <thead className="bg-white sticky top-0 shadow-sm border-b text-[10px] text-slate-400 font-bold uppercase">
                                <tr>
                                  <th className="px-6 py-3">目標專案</th>
                                  <th className="px-6 py-3 text-right">分攤工時</th>
                                </tr>
                              </thead>
                              <tbody className="divide-y font-bold">
                                {sharedResults.map((item, idx) => (
                                  <tr key={idx} className="hover:bg-slate-50">
                                    <td className="px-6 py-4 text-xs text-slate-700">{item.project}</td>
                                    <td className="px-6 py-4 text-right text-indigo-600 font-bold">{item.hours} H</td>
                                  </tr>
                                ))}
                              </tbody>
                            </table>
                          ) : (
                            <div className="h-full flex flex-col items-center justify-center text-slate-300 p-10 text-center">
                              <Icon name="Share2" size={48} className="mb-4 opacity-20" />
                              <p className="text-xs font-bold">請輸入左側資訊並點擊計算</p>
                            </div>
                          )}
                        </div>
                        {sharedResults.length > 0 && (
                          <div className="p-4 bg-indigo-50 border-t flex justify-between items-center">
                            <span className="text-xs font-bold text-indigo-700">總計專案數: {sharedResults.length}</span>
                            <span className="text-xs font-bold text-indigo-700">平均每專案: {sharedResults[0].hours} H</span>
                          </div>
                        )}
                      </div>
                    </div>
                  </section>
                ) : activeTab === 'pending' || activeTab === 'source' ? (
                  <section className="space-y-4 animate-in fade-in duration-300 max-w-4xl mx-auto">
                    <div className="flex items-center justify-between">
                      <div className="flex items-center space-x-2 text-slate-900"><Icon name={activeTab === 'pending' ? "Inbox" : "Database"} size={20} /><h2 className="text-xl font-bold tracking-tight">{activeTab === 'pending' ? '待處理專區 (未歸檔)' : '數據明細總庫'}</h2></div>
                      <button onClick={() => handleExportCSV(activeTab === 'pending' ? pendingData : filteredData, '工時明細')} className="flex items-center space-x-1.5 px-4 py-2 bg-slate-900 text-white rounded-xl text-xs font-bold hover:bg-black tracking-widest"><Icon name="FileDown" size={14} /><span>匯出 CSV</span></button>
                    </div>
                    <div className="bg-white rounded-2xl shadow-xl border overflow-hidden relative">
                      {selectedIndices.size > 0 && (
                        <div className="absolute top-0 left-0 right-0 z-20 bg-slate-900 px-6 py-3.5 flex items-center justify-between shadow-lg animate-in slide-in-from-top">
                          <span className="text-white text-sm font-bold flex items-center"><Icon name="CheckSquare" size={16} className="mr-2 text-emerald-400" /> 已選取 {selectedIndices.size} 筆</span>
                          <div className="flex items-center space-x-2">
                            {['已上傳', '計算中', '已結案'].map(s => (
                              <button key={s} onClick={() => batchUpdateStatus(s)} className="bg-white/10 hover:bg-white/20 text-white text-[10px] px-3 py-1.5 rounded-lg font-bold transition-colors">{s}</button>
                            ))}
                            <button onClick={() => setSelectedIndices(new Set())} className="ml-4 text-white/60 hover:text-white transition-colors"><Icon name="Trash2" size={16} /></button>
                          </div>
                        </div>
                      )}
                      <div className="overflow-x-auto">
                        <table className="w-full text-left">
                          <thead className="bg-slate-50 border-b">
                            <tr>
                              <th className="px-4 py-4 w-12 text-center sticky left-0 bg-slate-50 z-10">
                                <button onClick={() => toggleSelectAll(activeTab === 'pending' ? pendingData : filteredData)} className="text-slate-400 hover:text-slate-900 transition-colors">
                                  {selectedIndices.size > 0 && selectedIndices.size === (activeTab === 'pending' ? pendingData.length : filteredData.length) ? <Icon name="CheckSquare" size={18} className="text-slate-900" /> : <Icon name="Square" size={18} />}
                                </button>
                              </th>
                              <th className="px-6 py-4 text-xs font-bold text-slate-500 border-r">狀態標記</th>
                              {sourceVisibleCols.map(idx => <th key={idx} className="px-6 py-4 text-xs font-bold text-slate-500">{headers[idx]}</th>)}
                            </tr>
                          </thead>
                          <tbody className="divide-y font-bold text-sm">
                            {(activeTab === 'pending' ? pendingData : filteredData).map(({ row, originalIdx }) => {
                              const isSharedSource = (row[colIndices.project] || '').includes('共用成本');
                              
                              return (
                                <tr key={originalIdx} className={`hover:bg-slate-50 transition-colors ${selectedIndices.has(originalIdx) ? 'bg-indigo-50/30' : ''} ${isSharedSource ? 'opacity-50 grayscale bg-slate-50/50' : ''}`}>
                                  <td className="px-4 py-4 text-center sticky left-0 bg-white group-hover:bg-slate-50 transition-colors">
                                    <button onClick={() => toggleSelectRow(originalIdx)} className={`${selectedIndices.has(originalIdx) ? 'text-indigo-600' : 'text-slate-300'}`}>
                                      {selectedIndices.has(originalIdx) ? <Icon name="CheckSquare" size={18} /> : <Icon name="Square" size={18} />}
                                    </button>
                                  </td>
                                  <td className="px-6 py-4 border-r whitespace-nowrap">
                                    <div className="flex flex-col space-y-1">
                                      <select value={statusMap[originalIdx] || '已上傳'} onChange={(e) => setStatusMap(prev => ({...prev, [originalIdx]: e.target.value}))} className={`text-[10px] font-bold px-3 py-1.5 rounded-lg border outline-none transition-all ${getStatusStyle(statusMap[originalIdx])}`}>
                                        <option value="已上傳">已上傳</option>
                                        <option value="計算中">計算中</option>
                                        <option value="已結案">已結案</option>
                                      </select>
                                      {isSharedSource && <span className="text-[9px] text-amber-600 bg-amber-50 px-1.5 py-0.5 rounded border border-amber-100 font-black">⚠️ 統計排除項</span>}
                                    </div>
                                  </td>
                                  {sourceVisibleCols.map(cIdx => <td key={cIdx} className="px-6 py-4 text-slate-700 whitespace-nowrap font-mono">{ (cIdx === colIndices.month || cIdx === colIndices.date) ? normalizeMonth(row[cIdx]) : row[cIdx] }</td>)}
                                </tr>
                              );
                            })}
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </section>
                ) : activeTab === 'pasteCalc' ? (
                  <section className="space-y-6 animate-in fade-in duration-300 max-w-4xl mx-auto">
                    <div className="flex items-center justify-between"><div className="flex items-center space-x-2"><Icon name="ClipboardList" size={20} className="text-slate-800" /><h2 className="text-xl font-bold tracking-tight">快速匯入工具</h2></div><button onClick={() => { setPastedText(""); setPastedResults([]); setParsedRowsToImport([]); setImportSuccess(false); setParseError(""); }} className="text-xs font-bold text-slate-400 hover:text-red-500 flex items-center uppercase tracking-widest"><Icon name="Trash2" size={14} className="mr-1" /> 清除內容</button></div>
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                      <div className="bg-white rounded-3xl border p-6 space-y-4 shadow-xl">
                        <div className="flex justify-between items-center font-bold text-sm text-slate-700"><span>文字輸入區</span><span className="text-[10px] bg-indigo-50 text-indigo-600 px-2 py-0.5 rounded uppercase font-bold">格式：專案 月份 工時</span></div>
                        <textarea value={pastedText} onChange={(e) => { setPastedText(e.target.value); setParseError(""); }} placeholder="範例：&#10;專案A  2026-01-15  8.555" className={`w-full h-80 bg-slate-50 border ${parseError ? 'border-red-300' : 'border-slate-100'} rounded-2xl p-4 text-sm font-mono outline-none resize-none font-bold`} />
                        {parseError && <div className="text-red-500 text-[10px] font-bold flex items-center"><Icon name="AlertCircle" size={12} className="mr-1" /> {parseError}</div>}
                        <button onClick={handleProcessPastedText} className="w-full bg-slate-900 text-white py-4 rounded-xl font-bold shadow-xl transition-all active:scale-[0.98]">立即預覽計算</button>
                      </div>
                      <div className="bg-white rounded-3xl border shadow-xl flex flex-col min-h-[460px] overflow-hidden">
                        <div className="px-6 py-4 border-b bg-slate-50 flex justify-between items-center"><h3 className="text-sm font-bold">加總預覽</h3>{pastedResults.length > 0 && !importSuccess && <button onClick={() => handleImportToSystem()} className="bg-slate-900 text-white text-[10px] px-4 py-2 rounded-lg font-bold shadow-lg active:scale-95 uppercase tracking-widest"><Icon name="Download" size={14} className="mr-1" /> 匯入待處理區</button>}{importSuccess && <span className="text-emerald-600 text-[10px] font-bold flex items-center uppercase tracking-widest"><Icon name="Check" size={14} className="mr-1" /> 匯入完成</span>}</div>
                        <div className="flex-1 overflow-y-auto">
                          {pastedResults.length > 0 ? (
                            <table className="w-full text-left">
                              <thead className="bg-white sticky top-0 shadow-sm border-b text-[10px] text-slate-400 font-bold uppercase"><tr><th className="px-6 py-3">專案</th><th className="px-6 py-3 text-center">月份</th><th className="px-6 py-3 text-right">工時</th></tr></thead>
                              <tbody className="divide-y font-bold">
                                {pastedResults.map((item, idx) => (<tr key={idx} className="hover:bg-slate-50"><td className="px-6 py-4 text-xs text-slate-700">{item.project}</td><td className="px-6 py-4 text-[10px] text-slate-500 text-center font-mono">{item.month}</td><td className="px-6 py-4 text-right text-slate-900 font-bold">{item.totalHours.toFixed(3)}H</td></tr>))}
                              </tbody>
                            </table>
                          ) : <div className="h-full flex flex-col items-center justify-center text-slate-300 p-10 text-center opacity-40 font-bold uppercase tracking-widest"><Icon name="Calculator" size={48} className="mb-4" /><p className="text-xs">請貼入數據並預覽</p></div>}
                        </div>
                      </div>
                    </div>
                  </section>
                ) : (
                  <div className="max-w-2xl mx-auto space-y-8 animate-in fade-in duration-500">
                    <div className="bg-white rounded-3xl border shadow-2xl overflow-hidden font-bold">
                       <div className="p-10 border-b bg-slate-50/30 text-center"><Icon name="Settings" size={40} className="text-slate-900 mx-auto mb-4 opacity-80" /><h2 className="text-2xl font-bold tracking-tight">系統連動與設定</h2></div>
                       <div className="p-10 space-y-8">
                         <div className="space-y-3"><label className="text-xs font-bold text-slate-400 uppercase tracking-widest flex items-center"><Icon name="Database" size={12} className="mr-2" /> Google Sheet 公開 CSV 連結</label><input type="text" value={csvUrl} onChange={(e) => setCsvUrl(e.target.value)} className="w-full bg-slate-50 border rounded-xl px-4 py-3.5 text-sm outline-none font-mono" /></div>
                         <div className="bg-slate-50 p-6 rounded-3xl border text-xs text-slate-600 space-y-4 shadow-inner">
                           <p className="flex items-center text-slate-900 uppercase tracking-widest font-black border-b pb-2"><Icon name="Info" size={14} className="mr-2" /> 數據計算邏輯提示</p>
                           <div className="space-y-2 leading-relaxed">
                            <p>1. 系統自動將「日期」標準化為 <b>YYYY-MM</b> 格式進行彙總。</p>
                            <p>2. 同步資料後預設狀態為「已上傳」，標記為結案後會自動歸檔。</p>
                            <p>3. 工時統計精度為 <b>小數點後三位</b>。</p>
                            <p>4. <b>重複計算預防</b>：系統會自動在統計報表中排除專案名稱含有「共用成本」的原始項目。</p>
                           </div>
                         </div>
                         <button onClick={() => { fetchSheetData(); setActiveTab('dashboard'); }} className="w-full bg-slate-900 text-white py-4.5 rounded-2xl font-bold shadow-xl active:scale-95 text-lg uppercase tracking-widest transition-all">更新設定並同步數據</button>
                       </div>
                    </div>
                    <div className="bg-white rounded-3xl border border-red-100 shadow-lg overflow-hidden p-6 bg-red-50/20 flex items-center justify-between">
                      <div className="flex items-center space-x-3 text-red-600 font-bold text-sm tracking-widest uppercase font-black"><Icon name="Trash2" size={20} /><span>重置區域：清空系統快取</span></div>
                      <button onClick={() => setShowClearConfirm(true)} className="bg-white border border-red-200 text-red-500 px-6 py-2 rounded-xl text-sm font-bold hover:bg-red-50 active:scale-95 shadow-sm uppercase tracking-widest font-black transition-colors">立即清除</button>
                    </div>
                  </div>
                )}
              </main>
            </div>
          );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
